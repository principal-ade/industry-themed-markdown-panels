# Solution: Markdown Panel Not Displaying Content

## Root Cause Analysis

The markdown panel is not displaying content because of **two critical mismatches** between how the web-ade application is providing data and how the panel expects to receive it:

### Issue 1: Wrong Slice Name
- **What web-ade is doing**: Creating a slice named `'markdown'`
- **What the panel expects**: A slice named `'active-file'`
- **Location**: `MarkdownPanel.tsx:52`
  ```typescript
  const activeFile = context.getSlice<ActiveFileSlice>('active-file');
  ```

### Issue 2: Wrong Data Structure
- **What web-ade is doing**: Storing raw markdown content as `slice.data = content`
- **What the panel expects**: An `ActiveFileSlice` object with specific properties

## The ActiveFileSlice Interface

From `@principal-ade/panel-framework-core/src/types/panel.types.ts:20-37`, the panel expects:

```typescript
interface ActiveFileSlice {
  // File content and metadata
  path: string;           // Relative path (e.g., "README.md")
  content: string;        // The actual markdown content
  type: string;           // File type: 'markdown', 'typescript', etc.
  size?: number;          // File size in bytes
  lastModified?: Date;    // When file was last modified
  encoding?: string;      // Default: 'utf-8'

  // Source information - WHERE this file came from
  source: FileTreeSource; // Full source context (local/remote, branch, repo info)

  // Optional: Selection/cursor position
  selection?: {
    start: { line: number; column: number };
    end: { line: number; column: number };
  };
}
```

## Solution for web-ade Application

### Option 1: Use the Correct Slice Name and Structure (Recommended)

Update `PanelContext.tsx` to create an `active-file` slice with the proper structure:

```typescript
// In PanelContext.tsx
import type { ActiveFileSlice, FileTreeSource } from '@principal-ade/panel-framework-core';

// When fetching the README
const fetchReadme = async () => {
  try {
    const response = await fetch(
      'https://api.github.com/repos/owner/repo/contents/README.md'
    );
    const data = await response.json();
    const content = atob(data.content); // Decode base64

    console.log(`[PanelContext] README fetched successfully, length: ${content.length}`);

    // Create the proper ActiveFileSlice structure
    const activeFileData: ActiveFileSlice = {
      path: 'README.md',
      content: content,
      type: 'markdown',
      size: content.length,
      lastModified: new Date(data.updated_at || Date.now()),
      encoding: 'utf-8',
      source: {
        type: 'remote',
        provider: 'github',
        owner: 'owner',
        name: 'repo',
        branch: 'main',
        location: 'README.md',
        url: data.html_url,
      } as FileTreeSource,
    };

    // Update the slice with the correct name and structure
    setSlices(prev => new Map(prev).set('active-file', {
      scope: 'repository',
      name: 'active-file',
      data: activeFileData,
      loading: false,
      error: null,
      refresh: async () => {
        await fetchReadme();
      },
    }));

  } catch (error) {
    console.error('[PanelContext] Failed to fetch README:', error);

    setSlices(prev => new Map(prev).set('active-file', {
      scope: 'repository',
      name: 'active-file',
      data: null,
      loading: false,
      error: error as Error,
      refresh: async () => {
        await fetchReadme();
      },
    }));
  }
};
```

### Option 2: Extend the Panel to Support Multiple Slice Names

If you need to support both `active-file` and `markdown` slices, you could create a custom version of the panel. However, this is **not recommended** as it breaks the standard interface.

## Answers to Task Questions

### 1. Does the panel automatically watch the slice data for changes?

**Yes**, but only for the `active-file` slice. The panel uses React hooks that will re-render when the context changes:

```typescript
// From MarkdownPanel.tsx:52
const activeFile = context.getSlice<ActiveFileSlice>('active-file');
```

When you update the slice via `setSlices()`, React will detect the change and re-render the component with the new data.

### 2. Do we need to emit a specific event to trigger content display?

**No**, events are optional. The panel watches the slice data directly. However, the panel **does listen** to the `file:opened` event (line 42) to reset its view state:

```typescript
events.on('file:opened', (event) => {
  console.log('Markdown Panel: File opened:', event.payload);
  setViewMode('document');
  setCurrentSlide(0);
});
```

You **can** emit this event for a better user experience, but it's not required for the content to display:

```typescript
// Optional: Emit file:opened event after updating the slice
events.emit({
  type: 'file:opened',
  source: 'web-ade',
  timestamp: Date.now(),
  payload: activeFileData,
});
```

### 3. Is there a specific format or structure the slice data needs to follow?

**Yes**, the slice data must be an `ActiveFileSlice` object (not a raw string). See the interface definition above and the example code in Option 1.

### 4. Should we use a different approach to load external README content?

**No**, your current approach is fine. The issue is just how you're storing the data:

✅ **Current approach (fetching)**: Good
❌ **Current storage (raw string in 'markdown' slice)**: Wrong
✅ **Correct storage (ActiveFileSlice object in 'active-file' slice)**: Right

## Implementation Checklist

- [ ] Change slice name from `'markdown'` to `'active-file'`
- [ ] Update slice data to use `ActiveFileSlice` structure
- [ ] Include all required fields: `path`, `content`, `type`, `source`
- [ ] Set `type: 'markdown'` to ensure the panel recognizes it as markdown
- [ ] Provide proper `source` object with `type: 'remote'` and GitHub info
- [ ] (Optional) Emit `file:opened` event after loading for better UX
- [ ] Test that README displays correctly in the panel
- [ ] Verify loading and error states work properly

## Testing the Fix

After implementing the changes, verify:

1. The console shows: `[PanelContext] README fetched successfully, length: 3774`
2. The panel header shows "README.md" with the file icon
3. The source banner shows: `Source: github: owner/repo@README.md`
4. The markdown content renders in the panel
5. Font size controls work
6. If the README has `---` dividers, the document/slides toggle appears

## Example FileTreeSource Objects

### For GitHub Files
```typescript
source: {
  type: 'remote',
  provider: 'github',
  owner: 'principal-ade',
  name: 'industry-themed-markdown-panels',
  branch: 'main',
  location: 'README.md',
  url: 'https://github.com/principal-ade/industry-themed-markdown-panels/blob/main/README.md',
}
```

### For Local Files
```typescript
source: {
  type: 'local',
  name: 'my-project',
  path: '/Users/developer/my-project',
  location: 'README.md',
}
```

## Related Files

- **Panel Implementation**: `industry-themed-markdown-panels/src/panels/MarkdownPanel.tsx`
- **Type Definitions**: `@principal-ade/panel-framework-core/src/types/panel.types.ts`
- **Expected Updates**: `web-ade/src/contexts/PanelContext.tsx` (lines 38-137)
